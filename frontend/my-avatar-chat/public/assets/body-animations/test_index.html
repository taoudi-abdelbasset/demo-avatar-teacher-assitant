<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FBX Test - WORKING VERSION</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #container { width: 100vw; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        #info {
            position: absolute; top: 20px; left: 20px; color: white;
            background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px;
            z-index: 100; max-width: 400px; font-size: 12px;
        }
        #controls {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%); display: flex; gap: 10px; z-index: 100;
        }
        button {
            padding: 12px 24px; background: white; border: none;
            border-radius: 8px; cursor: pointer; font-weight: bold;
            transition: all 0.3s;
        }
        button:hover { background: #667eea; color: white; transform: scale(1.05); }
        .success { color: #4ade80; }
        .error { color: #f87171; }
    </style>
</head>
<body>
    <div id="container"></div>
    <div id="info">
        <h3>ðŸŽ¬ FBX Animation Test</h3>
        <div id="status">Initializing...</div>
    </div>
    <div id="controls">
        <button onclick="location.reload()">ðŸ”„ Reload</button>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const statusDiv = document.getElementById('status');
        function log(msg, type = 'info') {
            const color = type === 'success' ? '#4ade80' : type === 'error' ? '#f87171' : 'white';
            statusDiv.innerHTML += `<div style="color:${color}">${msg}</div>`;
            console.log(msg);
        }

        // Scene setup
        const container = document.getElementById('container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x667eea);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.6, 0.8); // Much closer!

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 1.6, 0); // Look at head height
        controls.enableDamping = true;
        controls.minDistance = 0.5; // Can zoom in very close
        controls.maxDistance = 2; // Can't zoom out too far

        // Add a grid to see the ground
        const gridHelper = new THREE.GridHelper(10, 10, 0xffffff, 0xffffff);
        gridHelper.material.opacity = 0.2;
        gridHelper.material.transparent = true;
        scene.add(gridHelper);

        // Brighter lighting
        scene.add(new THREE.AmbientLight(0xffffff, 1.2));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);
        
        const fillLight = new THREE.DirectionalLight(0xffffff, 0.8);
        fillLight.position.set(-5, 5, -5);
        scene.add(fillLight);

        let mixer = null;
        let currentAction = null;
        let avatarHead = null;
        const clock = new THREE.Clock();

        // Load Avatar
        log('â³ Loading ReadyPlayerMe avatar...');
        const gltfLoader = new GLTFLoader();
        
        gltfLoader.load(
            'https://models.readyplayer.me/66473ec24c3b647e2d45ab9b.glb',
            (gltf) => {
                log('âœ… Avatar loaded!', 'success');
                
                const avatarModel = gltf.scene;
                scene.add(avatarModel);

                // Center model at origin
                const box = new THREE.Box3().setFromObject(avatarModel);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                
                avatarModel.position.sub(center);
                avatarModel.position.y = 0; // Put feet on ground
                
                log(`ðŸ“ Avatar size: ${size.y.toFixed(2)}m tall`);
                log(`ðŸ“ Avatar positioned at origin`);

                mixer = new THREE.AnimationMixer(avatarModel);
                
                // Log bone structure
                log('ðŸ¦´ Scanning bone hierarchy...');
                const bones = [];
                avatarModel.traverse((node) => {
                    if (node.isBone) {
                        bones.push(node.name);
                    }
                });
                log(`Found ${bones.length} bones: ${bones.slice(0, 5).join(', ')}...`, 'success');

                // Find head bone for camera tracking
                avatarModel.traverse((node) => {
                    if (node.isBone && (node.name === 'Head' || node.name === 'head')) {
                        avatarHead = node;
                        log('âœ… Found Head bone for camera tracking!', 'success');
                    }
                });

                // Load FBX animation
                loadFBXAnimation(avatarModel);
            },
            (progress) => {
                const percent = (progress.loaded / progress.total * 100).toFixed(0);
                log(`â³ Loading avatar... ${percent}%`);
            },
            (error) => {
                log('âŒ Error loading avatar: ' + error, 'error');
            }
        );

        // Load FBX Animation
        function loadFBXAnimation(avatarModel) {
            log('â³ Loading FBX animation...');
            const fbxLoader = new FBXLoader();

            fbxLoader.load(
                './idle/breathing_idle.fbx',
                (fbx) => {
                    log('âœ… FBX loaded!', 'success');

                    if (!fbx.animations || fbx.animations.length === 0) {
                        log('âŒ No animations in FBX!', 'error');
                        return;
                    }

                    const clip = fbx.animations[0];
                    log(`ðŸ“Š Animation: ${clip.name} (${clip.duration.toFixed(2)}s, ${clip.tracks.length} tracks)`);

                    // RETARGETING: Remove 'mixamorig' prefix ONLY
                    const newTracks = clip.tracks
                        .filter(track => {
                            // REMOVE ALL POSITION TRACKS - only keep rotations!
                            if (track.name.includes('.position')) {
                                log(`âŒ Removed: ${track.name}`);
                                return false;
                            }
                            return true;
                        })
                        .map(track => {
                            const newTrack = track.clone();
                            // Simple: mixamorigHips.quaternion -> Hips.quaternion
                            newTrack.name = track.name.replace('mixamorig', '');
                            return newTrack;
                        });

                    const retargetedClip = new THREE.AnimationClip(clip.name, clip.duration, newTracks);
                    log(`âœ… Retargeted to ${newTracks.length} tracks (rotations only)`, 'success');

                    // Apply animation
                    currentAction = mixer.clipAction(retargetedClip);
                    currentAction.setLoop(THREE.LoopRepeat, Infinity);
                    currentAction.clampWhenFinished = false;
                    currentAction.play();

                    log('ðŸŽ¬ ANIMATION PLAYING! (Check if avatar is breathing)', 'success');
                    log('ðŸ’¡ TIP: Drag to rotate camera, scroll to zoom', 'success');
                },
                undefined,
                (error) => {
                    log('âŒ Error loading FBX: ' + error, 'error');
                }
            );
        }

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            if (mixer) {
                mixer.update(clock.getDelta());
            }
            
            // Camera follows head
            if (avatarHead) {
                const headPos = new THREE.Vector3();
                avatarHead.getWorldPosition(headPos);
                controls.target.copy(headPos);
            }
            
            controls.update();
            renderer.render(scene, camera);
        }

        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>